AWSTemplateFormatVersion: '2010-09-09'
Description: CloudTrail that records management events and ECR data events into an S3 bucket.

Parameters:
  TrailName:
    Type: String
    Default: ecommerce-aws-cloudtrail
  # No S3BucketName parameter: the template creates a dedicated bucket for CloudTrail logs.

Resources:
  CloudTrailBucket:
    Type: AWS::S3::Bucket
    Properties:
      # If S3BucketName parameter is provided, CloudFormation does not allow conditional BucketName property for S3::Bucket.
      # We'll create a new bucket always and the parameter can be used externally if needed.
      BucketName: !Sub "ecommerce-aws-cloudtrail-logs-${AWS::AccountId}-${AWS::Region}"
      VersioningConfiguration:
        Status: Enabled

  CloudTrailLogPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudTrailBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowCloudTrailPutObject
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource:
              Fn::Join:
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref CloudTrailBucket
                  - '/AWSLogs/'
                  - !Ref 'AWS::AccountId'
                  - '/*'

  CloudTrail:
    Type: AWS::CloudTrail::Trail
    Properties:
      TrailName: !Ref TrailName
      S3BucketName: !Ref CloudTrailBucket
      IsMultiRegionTrail: true
      IncludeGlobalServiceEvents: true
      EnableLogFileValidation: true
      IsLogging: true
      EventSelectors:
        - ReadWriteType: All
          IncludeManagementEvents: true
        - ReadWriteType: All
          IncludeManagementEvents: false
          DataResources:
            - Type: AWS::ECR::Repository
              Values:
                - !Sub "arn:aws:ecr:${AWS::Region}:${AWS::AccountId}:repository/*"

Outputs:
  CloudTrailBucketName:
    Description: S3 bucket used by CloudTrail
    Value: !Ref CloudTrailBucket
